<!doctype html>
<html lang="en">
<head>
  <title>{{ title }}</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="/static/main.css">
  <link rel="stylesheet" href="/static/magnific-popup.css">
</head>
<body>

    <div id="header">
      <h1><a href="/">root</a></h1>
      <nav>
        <a href="/">root</a>
        <a href="/about.html">about</a>
        <a href="mailto:email@address">email@address</a>
      </nav>
    </div>

  <div id="album">
  {% for photo in photos %}
  <a title="Click image to enlarge" href="{{photo.url}}" class="photolink"><img src="{{photo.thumbnail}}" alt="{{photo.title}}" data-width="{{photo.width}}" data-height="{{photo.height}}"></a>
  {% endfor %}
  </div>

    <script src="/static/jquery-1.7.2.min.js"></script>
    <script src="/static/jquery.magnific-popup.js"></script>  
    <script>
      /* Inspired by http://blog.vjeux.com/2012/image/image-layout-algorithm-google-plus.html */

      var ALBUM_BORDER_WIDTH = 10;
      var IMAGE_SPACING = 4;

      function get_height_for_row(images, album_width)
      {
          var ratios = 0;
          $.each(images, function(i, img) {
              ratios += $(img).data('width') / $(img).data('height');
          });
          var row_height = album_width / ratios;
          return row_height;
      }

      function resize_row(images, album_width)
      {
          var row_height = get_height_for_row(images, album_width);
          $.each(images, function(i, img) {
              $(img).height(row_height);
          });
          return row_height;
      }

      function run(max_height) {
        var album_width = $('#album').width() - 2;
        var images = $('#album img');

        var row = [];
        var current_row_width = 0;
        var smallest_height_in_row = 0;
        var smallest_row_height = 0;
        $.each(images, function(i, img) {
            var img_height = $(img).data('height');
            var spacing_width = row.length * 5;
            if( (current_row_width + spacing_width) > album_width ) {
                var resized_height = resize_row(row, album_width - spacing_width);
                if( smallest_row_height == 0 || resized_height < smallest_row_height) {
                    smallest_row_height = resized_height;
                }

                row = [];
                current_row_width = 0;
                smallest_height_in_row = 0;
            }

            if( smallest_height_in_row == 0 ) {
                smallest_height_in_row = img_height;
            } else if( img_height < smallest_height_in_row) {
                var ratio_to_shrink = img_height / smallest_height_in_row;
                current_row_width *= ratio_to_shrink;
                smallest_height_in_row = img_height;
            }

            var ratio_to_shrink = img_height / smallest_height_in_row;

            current_row_width += $(img).data('width') * ratio_to_shrink;
            row.push(img)

        });

        var spacing_width = row.length * 5;
        var row_height = Math.min.apply(Math, [
            get_height_for_row(row, album_width - spacing_width),
            smallest_height_in_row,
            smallest_row_height
            ]);
        $.each(row, function(i, img) {
            $(img).height(row_height);
        });

      }

      function imageTitle(obj) {
        var img = obj.el.children('img');
        var title = img.attr('alt');
        return title;
      }

      $(window).resize(function () { run(366); });
      $(function() {
        run(366);

        $('#album').magnificPopup({
          delegate: 'a.photolink',
          closeOnContentClick: true,
          showCloseBtn: false,
          type: 'image',
          gallery: {
            enabled: true,
            preload: [1,3],
            navigateByImgClick: false,
            tCounter: ''
          },

          image: {
            titleSrc: imageTitle,
            cursor: 'justregularplease'
          },
          mainClass: 'mfp-with-zoom',
          zoom: {
            enabled: true,
            duration: 300,
            easing: 'ease-in-out',
            opener: function(openerElement) {
              return openerElement.is('img') ? openerElement : openerElement.find('img');
            }
        }
        });
      });
    </script>

</body>
</html>

